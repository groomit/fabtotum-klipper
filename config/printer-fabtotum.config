# This file is made for a Fabtotum Personal Fabricator Core using 
# the Printing Head Pro.
# It is based on the example config file for corexy (and also h-bot)
# style printers. 
#
# Firmware build and flash instruction:
# Within the klipper folder run:
# $ make menu config
# Select Atmega 1280 and safe the changes. Then run
# $ make
# The binary needs to be flashed manually to the totumduino board by using an ISP-Programmer.
# Depending on the programmer used, the command should look something like this: 
# $ avrdude -p m1280 -c stk500v2 -P /dev/ttyUSB0 -v -U flash:r:~/klipper/out/klipper elf.hex:i
#
# The Raspberry Pi in the Fabtotum is connected to the totumduino
# directly through it's GPIO-Header. The standard serial interface
# on the GPIO /dev/ttyS0 does not provide a stable baudrate.
# Therefore it is necessary to make the /dev/ttyAMA0 interface available
# on GPIO 14 and 15.
# To do so on Raspian you need to add following two lines at the end of
# /boot/firmware/config.txt:
# enable_uart=1
# dtoverlay=disable-bt
#
# Finally run following command: 
# $ sudo systemctl disable hciuart
#
# Please carefully check and test the settings. The author is not responsible 
# for any damage or injury resulting from using this config file.
#
# DO NOT COPY THIS FILE WITHOUT CAREFULLY READING AND UPDATING IT
# FIRST. Incorrectly configured parameters may cause damage.
#
# See docs/Config_Reference.md for a description of parameters.

[mcu]
serial: /dev/ttyAMA0
restart_method: command

[printer]
kinematics: corexy
max_velocity: 300
max_accel: 3000
max_z_velocity: 25
max_z_accel: 30

[led my_led]
red_pin: !PE3
green_pin: !PH4
blue_pin: !PB6
initial_RED: 1.0
initial_GREEN: 1.0
initial_BLUE: 1.0

# right motor
[stepper_x]
step_pin: PF6
dir_pin: PF7
enable_pin: !PF2
microsteps: 16
rotation_distance: 44
endstop_pin: !PE4
position_endstop: 0
position_max: 214
homing_speed: 30

#left motor
[stepper_y]
step_pin: PF0
dir_pin: PF1
enable_pin: !PD7
microsteps: 16
rotation_distance: 44
endstop_pin: !PJ1
position_endstop: 0
position_max: 234
homing_speed: 30

[stepper_z]
step_pin: PL3
dir_pin: !PL1
enable_pin: !PK0
microsteps: 16
rotation_distance: 1.5
endstop_pin: !PD3
position_endstop: 241.5
position_max: 241.5
homing_speed: 15

##UNTESTED - Bowden Print Head V2
#[extruder]
#step_pin: PA4
#dir_pin: PA6
#enable_pin: !PA2
#microsteps: 16
#rotation_distance: 35
#nozzle_diameter: 0.400
#filament_diameter: 1.750
#heater_pin: PB4
#sensor_type: Generic 3950
#sensor_pin: PK5
#control: pid
#pid_Kp: 20.0
#pid_Ki: 3.5
#pid_Kd: 30.0
#min_temp: 10
#max_temp: 260
#min_extrude_temp: 175

#Printing Head Pro
[extruder]
step_pin: PD0
dir_pin: !PD1
enable_pin: !PA1
microsteps: 8
rotation_distance: 2.2
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PB4
sensor_type: Generic 3950
sensor_pin: PK5
control: pid
pid_kp: 25.407
pid_ki: 1.093
pid_kd: 147.676
min_temp: 10
max_temp: 260
min_extrude_temp: 175

[firmware_retraction]
retract_length: 0.5
retract_speed: 20
unretract_speed: 20

[heater_bed]
heater_pin: PH5
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PK6
control: pid
pid_kp: 58.664
pid_ki: 0.925
pid_kd: 930.555
min_temp: 10
max_temp: 110

[fan]
pin: PH6

[servo probe_servo]
pin: PB5
maximum_servo_angle: 127
minimum_pulse_width: 0.000544
maximum_pulse_width: 0.0024
initial_angle: 26

[probe]
pin: !PD2
x_offset: -17.0
y_offset: -61.5
z_offset: -31.65
activate_gcode:
  SET_SERVO SERVO=probe_servo ANGLE=127
	G4 P200
deactivate_gcode:
  SET_SERVO SERVO=probe_servo ANGLE=26
	G4 P100

[bed_mesh]
mesh_min: 20, 20
mesh_max: 200, 200
probe_count: 4, 4

# Just for error checking. Not necessary for use of the device
[duplicate_pin_override]
pins: PB4, PK5

# Enable "Milling Motor" Powerline on head carriage on boot. (Originally only on for installed Pro Head or Milling head)
[output_pin head_motor_pin]
pin: PG0
value: 1
shutdown_value: 0

[filament_switch_sensor wire_end_sensor]
switch_pin: PE2
pause_on_runout: true

##################################################
### Macros
##################################################

[gcode_macro START_PRINT]
gcode:
    {% set BED_TEMP = params.BED_TEMP|default(40)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(180)|float %}
    # Start bed heating
    M140 S{BED_TEMP}
    # Use absolute coordinates
    G90
    # Reset the G-Code Z offset (adjust Z offset if needed)
    SET_GCODE_OFFSET Z=0.0
    # Home the printer
    G28
    # Move the nozzle near the bed
    G1 Z50 F3000
    # Wait for bed to reach temperature
    M190 S{BED_TEMP}
    # Set and wait for nozzle to reach temperature
    M109 S{EXTRUDER_TEMP}
    # Buffer and play the signal tone upon start
    G4 S1 
    M300 S2
    G4 S1
    # Prime the nozzle by slowly extruding 35mm of filament (zero E-length before and afterwards)
    G92 E0
    G1 F200 E35
    G92 E0

[gcode_macro END_PRINT]
gcode:
    # Turn off bed, extruder, and fan
    M140 S0
    M104 S0
    M106 S0
    # Move nozzle away from print while retracting
    G91
    G1 X-2 Y-2 E-3 F300
    # Raise nozzle by 10mm
    G1 Z10 F3000
    G90
    # Disable steppers
    M84
    # Signal print end by beeping
    M300 S2
